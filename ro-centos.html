<h1>steps to get a stateless read-only CentOS with a nfs-root.</h1>

<h2>Create base image </h2>

<h3>Disks</h3>

<p>First install CentOS to a machine that will be used to generate your base image. There are two main cases:</p>
<ul>
	<li>You wish to use the machine's disk, and you will need two partitions ondisk labeled following the RW_LABAEL and STATE_LABEL in your /etc/sysconfig/readonly-root file (stateless-rw and stateless-state by default).
	<li>You wish the system to act as if it were diskless (such as being really diskless, or using the disks for other data than the OS). In this case you will need to also setup your NFS server accordingly. We will cover this case with the setup of the NFS server.
</ul>

<h3>Packages</h3>

<p>Install as usual, then ensure that the following packages are installed:</p>
<ul>
	<li> dracut-network
	<li> dracut-config-generic (needed to create non-host-specific images)
	<li> nfs-utils
	<li> rsync
	<li> remove NetworkManager as it causes crashes when the network goes down.
</ul>
	<p>Also install now any packages you will need later as the system will be read-only. (You can always correct errors later using <code>mount -o remount,rw</code> as long as you don't define your nfs shares as RO).</p>

<h3>Systemd units</h3>

<p>You will want to disable</p>
<ul>
	<li> systemd-readahead-collect.service: 
		It attempts to write the disk usage pattern used at boot time. See man systemd-readahead for more details. You can also add /.readahead in the rw or state lists if you wish to keep this function.
</ul>
<p>Depending on your setup, you need to test and watch with the following units:</p>
<ul>
	<li> systemd-tmpfiles:
		This service reads from <code>/etc/tmpfiles.d</code>, <code>/usr/lib/tmpfiles.d</code> and <code>/run/tmpfiles.d</code> to find conf files that require it to create/destroy temporary files/directories. Therefore any systemd-aware program may write in one of these directories a .conf file that asks for a particular directory/file to be created and/or removed on start/stop.
	<li> daemons that need to read/write sockets in weird places.

<h3>Setup rw/state</h3>

<p>Depending on your needs, you will need to add different files/dirs to the /etc/rwtab and /etc/statetab, respectively temporary and persistent places to write. The script will then take care of bound-mounting everything where they should be. Whatever your setup, you will want to make sure you have:</p>
<ul>
	<li> in <code>/etc/rwtab</code>:
		<ul>
			<li><code>files /etc/localtime</code>
			<li><code>dirs  /var/lock</code>
			<li><code>files /var/lib/postfix/master.lock</code>
			<li><code>dirs  /var/lib/gssproxy/</code>
		</ul>
	<li>in <code>/etc/statetab</code>
		<ul>
			<li><code>/var/log</code> (you might as well want to log to your master server's syslog though)
		</ul>
</ul>

<h3>Setup as read-only</h3>

<p>To tell the system to boot in ro-mode with all the done config, you need to edit the <code>/etc/sysconfig/readonly-root</code> file:
  <pre><code>
  cat >>/etc/sysconfig/readonly-root << EOF
  READONLY=yes
  TEMPORARY_STATE=yes
  RW_MOUNT=/var/lib/stateless/writable
  RW_LABEL=stateless-rw #/!\
  RW_OPTIONS=
  STATE_LABEL=stateless-state #/!\
  STATE_MOUNT=/var/lib/stateless/state
  STATE_OPTIONS=
  CLIENTSTATE= #/!\
  SLAVE_MOUNTS=yes

  EOF
  </code></pre>

<p>Depending on your case as explained in the Disks section, you will want to:</p>
<ul>
	<li> If you wish a diskless system, comment out the <code>{RW,STATE}_LABEL</code> lines, and add <code>&lt;nfs server ip add&rt;:/path/to/state/export</code> (see the following nfs setup) in the <code>CLIENTSTATE</code> field.
	<li>If you wish to use the machine's disk, leave the labels uncommented and set to the labels you gave your partitions in the Disks part. Leave the <code>CLIENTSTATE</code> field empty.
</ul>

<h3>Setup nfs server</h3>

<p>You will need to setup a server with an nfs export that will be used as the root for your stateless machines. It should not be necessary to force the export to be ro, though you could do it for security enhancement (note that you will then not be able to modify your system from one of the nodes using <code>mount -o remount,rw</code> and will either have to have a master with write access, or chroot from your server). If you also wish to keep your machine states in the nfs server, create another nfs export, the path of which goes in the <code>CLIENTSTATE</code> field in <code>/etc/sysconfig/readonly-root</code>. Inside the top directory of this export, create a folder containing the FQDN of each node you will deploy.</p>

<h3>create the initrd</h3>
<h4>first generation</h4>
<p>create a list of loaded kernel modules using the following command:</br>
<code>xs=$(lsmod|grep -v Module|awk '{printf "%s ",$1}')</code> (do not hesitate to check echo $xs to be sure you have not forgotten anything)
Modify the <code>/etc/dracut.conf</code> file to add your network driver to the 'add_drivers' field, and 'nfs' in the 'add_dracutmodules' field.
Finally create your image using <code>dracut -a "nfs network kernel-modules base" --add-drivers "$xs" --kernel-cmdline "root=nfs:&lt;nfs-server ip&rt;:/path/to/export/root" -f initramfs-nfs.img</code></p>
<h4>General setup</h4>
<p> you are now going to want to setup the <code>/etc/dracut.conf</code> file so that a correct image is generated on kernel updates. You just need to hardcode in it the different cmdlines used previously (the <code>kernel_cmdline</code> option does not appear in the defaul example file but it is present -- see man dracut.conf). In the last part we will setup a script that automatically updates the nfs server.

<h3>Put all files in the remote</h3>

<p>copy the new initramfs to your remote PXEboot server
<code>scp initramfs-nfs.img root@&lt;your server&gt;:/your/pxeboot/path/</code></p>

<p>Make sure you do not have autofs working (or you will have an infinite mounting loop   * much fun!) and copy the system to your nfs server:
<code>rsync -aH --exclude=/{proc,sys,dev,media,mnt,tmp,home,run,srv}/  * / root@&lt;your server&gt;:/path/to/export/root</code></p>

<h3>Cleanup on the remote files</h3>
<p>ssh into your server and edit the following files in the root export:
<ul>
	<li> Your fstab should contain:
		<pre><code>
			none 	/tmp 	 tmpfs 	defaults   0 0
			tmpfs 	/dev/shm tmpfs 	defaults   0 0
			sysfs 	/sys 	 sysfs 	defaults   0 0
			proc 	/proc 	 proc 	defaults   0 0
		</code></pre>
	<li> Remove any yum old files: <code>rm /var/lib/rpm/__db*</code> (otherwise the systemd service that does so on boot will fail)
	<li> Ensure you only have the lo interface in /etc/sysconfig/network-scripts/ifcfg-* &ndash; dracut will autogenerate the needed files.
	<li> Remove the <code>/etc/hostname</code> so the nodes will take their hostname from the network.
	<li>any other file that may contain HW specific info
</ul></p>

<h3>Keeping the system up to date</h3>

